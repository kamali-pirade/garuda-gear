<div id="product-modal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div class="bg-white rounded-lg shadow-lg w-11/12 sm:w-4/5 md:w-1/2 lg:w-2/5 max-h-[90vh] overflow-y-auto">
    <div class="flex items-center justify-between p-4 border-b">
      <h3 id="modal-title" class="text-xl font-semibold text-gray-900">
        Product Form
      </h3>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideProductModal()">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>
    <div class="px-6 py-4 space-y-4 form-style">
      <form id="product-form">
        <input type="hidden" id="form-product-id" name="product_id">
        <div id="form-errors" class="hidden mb-4"></div>
        
        <div>
            <label for="form-name" class="block text-sm font-medium text-gray-700 mb-1">Name</label>
            <input type="text" id="form-name" name="name" class="w-full" required>
        </div>
        <div>
            <label for="form-price" class="block text-sm font-medium text-gray-700 mb-1">Price</label>
            <input type="number" id="form-price" name="price" class="w-full" required>
        </div>
        <div>
            <label for="form-brand" class="block text-sm font-medium text-gray-700 mb-1">Brand</label>
            <input type="text" id="form-brand" name="brand" class="w-full" required>
        </div>
        <div>
            <label for="form-stock" class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
            <input type="number" id="form-stock" name="stock" class="w-full" required>
        </div>
        <div>
            <label for="form-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea id="form-description" name="description" rows="3" class="w-full" required></textarea>
        </div>
        <div>
            <label for="form-thumbnail" class="block text-sm font-medium text-gray-700 mb-1">Thumbnail URL</label>
            <input type="url" id="form-thumbnail" name="thumbnail" class="w-full">
        </div>
        <div>
            <label for="form-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        
            <div class="relative">
                <select id="form-category" name="category" 
                        class="w-full appearance-none rounded-md border border-gray-300 bg-white px-3 py-2 pr-10 shadow-sm focus:border-[#4B40B5] focus:ring-[#4B40B5]" 
                        required>
                    <option value="top">Top</option>
                    <option value="bottom">Bottom</option>
                    <option value="socks">Socks</option>
                    <option value="shoes">Shoes</option>
                    <option value="equipment">Equipment</option>
                    <option value="other">Other</option>
                </select>
        
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5 text-gray-500">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                    </svg>
                </div>
            </div>
        </div>
        <div class="flex items-center mt-4">
            <input id="form-is_featured" name="is_featured" type="checkbox" class="w-4 h-4 text-[#4B40B5] bg-gray-100 border-gray-300 rounded">
            <label for="form-is_featured" class="ml-2 text-sm font-medium text-gray-900">Featured</label>
        </div>
      </form>
    </div>
    <div class="flex items-center justify-end p-6 border-t border-gray-200 rounded-b">
      <button type="button" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors" onclick="hideProductModal()">Cancel</button>
      <button type="submit" form="product-form" class="ml-3 bg-[#4B40B5] text-white px-6 py-2 rounded-md font-medium hover:bg-[#372e8c] transition-colors">Save Product</button>
    </div>
  </div>
</div>

<script>
    const productModal = document.getElementById('product-modal');
    const modalTitle = document.getElementById('modal-title');
    const productForm = document.getElementById('product-form');
    const formErrors = document.getElementById('form-errors');

    function showCreateModal() {
        productForm.reset();
        modalTitle.textContent = "Add New Product";
        document.getElementById('form-product-id').value = '';
        formErrors.classList.add('hidden');
        productModal.classList.remove('hidden');
    }

    async function showEditModal(productId) {
        productForm.reset();
        modalTitle.textContent = "Edit Product";
        formErrors.classList.add('hidden');

        try {
            const response = await fetch(`/edit-product-ajax/${productId}/`);
            const result = await response.json();

            if (result.status === 'success') {
                const data = result.data;
                document.getElementById('form-product-id').value = productId;
                document.getElementById('form-name').value = data.name;
                document.getElementById('form-price').value = data.price;
                document.getElementById('form-brand').value = data.brand;
                document.getElementById('form-stock').value = data.stock;
                document.getElementById('form-description').value = data.description;
                document.getElementById('form-thumbnail').value = data.thumbnail;
                document.getElementById('form-category').value = data.category;
                document.getElementById('form-is_featured').checked = data.is_featured;
                productModal.classList.remove('hidden');
            } else {
                showToast(result.message || 'Failed to fetch product data.', 'error');
            }
        } catch (error) {
            showToast('An error occurred while fetching data.', 'error');
        }
    }

    function hideProductModal() {
        productModal.classList.add('hidden');
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    productForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const productId = document.getElementById('form-product-id').value;
        const isEdit = productId !== '';
        
        const url = isEdit ? `/edit-product-ajax/${productId}/` : '{% url "main:add_product_ajax" %}';
        const formData = new FormData(productForm);

        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            const result = await response.json();

            if (result.status === 'success') {
                hideProductModal();
                showToast(result.message, 'success');
                document.dispatchEvent(new CustomEvent('product-changed'));
            } else {
                let errorHtml = '<div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700"><ul>';
                for (const field in result.errors) {
                    errorHtml += `<li><strong>${field}:</strong> ${result.errors[field][0]}</li>`;
                }
                errorHtml += '</ul></div>';
                formErrors.innerHTML = errorHtml;
                formErrors.classList.remove('hidden');
            }
        } catch (error) {
            showToast('An unexpected error occurred.', 'error');
        }
    });
</script>